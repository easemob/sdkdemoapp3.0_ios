
## 环信红包接入文档

##### 环信红包简介
环信红包是基于`环信 SDK2.2.5 ChatDemoUI3.0`开发的。可以让用户在做最少改动的情况下，快速集成红包功能。

##### SDK介绍
`RedpacketSDK`包含 `RedpacketStaticLib` 和 `RedpacketOpen`
`RedpacketStaticLib`静态库提供，实现了红包收发流程和账号安全体系。 
`RedpacketOpen`开源方式提供，实现了红包消息的展示


#### Step1. 导入SDK
 将红包库`RedpacketSDK`添加到工程里。

#### Step2. 配置商户ID
**@Class:** *AppDelegate*

**@Function:** *- (BOOL)application:(UIApplication \*)application didFinishLaunchingWithOptions:(NSDictionary \*)launchOptions；*

**@description:** appKey为环信分配的appKey

```
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
{   
	//TODO:1 配置商户的AppKey
    [[RedPacketUserConfig sharedConfig] configWithAppKey:@"easemob-demo#chatdemoui"];
    
    ...
    ...
}
    
```

#### Step3.公开协议

**@class:** *ChatViewController*

**@description:** 开放协议，将`ChatViewController.m`中的协议`<EaseMessageViewControllerDelegate, EaseMessageViewControllerDataSource>`，公开到`ChatViewController.h`中

```
//	修改后.h文件
@interface ChatViewController : EaseMessageViewController <EaseMessageViewControllerDelegate, EaseMessageViewControllerDataSource>

```

#### Step4.替换聊天窗口ChatViewController
**@OriginClass:** *ChatViewController*

**@ReplaceClass:** *RedPacketChatViewController*

**@description:** 替代*ChatViewController*为*RedPacketChatViewController（带有红包功能的聊天窗口）*
#### Step5.检查红包按钮索引
**@Class:** *RedPacketChatViewController*

**@description:** 不同的App，聊天界面中更多功能列表页里的功能按钮数量可能不同，对应的位置也可能不同，所以要保证索引值正确。

**@Function:** 

*- (void)messageViewController:(EaseMessageViewController *)viewController didSelectMoreView:(EaseChatBarMoreView *)moreView AtIndex:(NSInteger)index*
```
/**
 *  红包单击事件索引
 */
static NSInteger const _redpacket_send_index   = 5;```#### Step6.群红包消息透传
**@Class:** *MainViewController*
**@description:** 群红包被抢，抢红包的人和发红包的人，都要收到你抢了***的红包或者***的抢了你的红包， 抢红包消息是通过cmd消息实现，在这里需要将cmd消息处理成txt消息。

**@Function:** 
-(void)didReceiveCmdMessage:(EMMessage *)message
- (void)didReceiveOfflineCmdMessages:(NSArray *)offlineCmdMessages
-(void)didReceiveMessage:(EMMessage *)message

```
//	复制以下代码到MainViewController中，替换原有的方法。

/**
 *  TODO: [Step6] RedpacketSDK
 */
 
- (void)didReceiveOfflineCmdMessages:(NSArray *)offlineCmdMessages
{
    /**
     *  收到红包被抢的
     */
    for (EMMessage *message in offlineCmdMessages) {
        EMCommandMessageBody * body = (EMCommandMessageBody *)message.messageBodies[0];
        if ([body.action isEqualToString:RedpacketKeyRedapcketCmd]) {
            [self handleCmdMessage:message];
        }
    }
}

-(void)didReceiveCmdMessage:(EMMessage *)message
{
    // 群红包透传处理
    EMCommandMessageBody * body = (EMCommandMessageBody *)message.messageBodies[0];
    
    if ([body.action isEqualToString:RedpacketKeyRedapcketCmd]) {
        [self handleCmdMessage:message];
        
    }else{
        //环信原调用
        [self showHint:NSLocalizedString(@"receiveCmd", @"receive cmd message")];
    }
}

- (void)handleCmdMessage:(EMMessage *)message
{
    NSDictionary *dict = message.ext;
    NSString *senderID = [dict valueForKey:RedpacketKeyRedpacketSenderId];
    NSString *receiverID = [dict valueForKey:RedpacketKeyRedpacketReceiverId];
    NSString *currentUserID = [[[[EaseMob sharedInstance] chatManager] loginInfo] objectForKey:kSDKUsername];
    
    if ([senderID isEqualToString:currentUserID]){
        /**
         *  当前用户是红包发送者。
         */
        NSString *text = [NSString stringWithFormat:@"%@领取了你的红包",receiverID];
        NSString *willSendText = [EaseConvertToCommonEmoticonsHelper convertToCommonEmoticons:text];
        EMChatText *textChat = [[EMChatText alloc] initWithText:willSendText];
        EMTextMessageBody *body1 = [[EMTextMessageBody alloc] initWithChatObject:textChat];
        EMMessage *SelfMessage = [[EMMessage alloc] initWithReceiver:message.conversationChatter bodies:[NSArray arrayWithObject:body1]];
        SelfMessage.requireEncryption = NO;
        SelfMessage.messageType = eMessageTypeGroupChat;
        SelfMessage.ext = message.ext;
        SelfMessage.deliveryState = eMessageDeliveryState_Delivered;
        SelfMessage.isRead = YES;
        
        /**
         *  插入数据库，并更新当前聊天界面
         */
        [[EaseMob sharedInstance].chatManager insertMessageToDB:SelfMessage append2Chat:YES];
    }
}
I
```

```

/**
 *  TODO: [Step6]: 屏蔽震动消息
 */
 
-(void)didReceiveMessage:(EMMessage *)message
{
    NSDictionary *dict = message.ext;
    /**
     *  红包被抢的消息不提示，不震动
     */
    if (dict && [dict valueForKey:RedpacketKeyRedpacketTakenMessageSign]) {
        return;
    }
    
	...
	...
	
}

```

#### Step7.会话列表页

**@Class:** *MainViewController*

**@description:** 修改会话列表页，当某人抢了红包后显示正确的提示信息, 直接复制到以下代码到具体位置

**@Function:** 

- (NSString *)commonLatestMessageTitle:(EMMessage *)latestMessage```
\#pragma mark - 阅后即焚或普通消息内容显示
- (NSString *)commonLatestMessageTitle:(EMMessage *)latestMessage
{
    NSString *latestMessageTitle = @"";
    if (latestMessage.ext &&
        [EaseMessageHelper isRemoveAfterReadMessage:latestMessage] &&
        [latestMessage.to isEqualToString:[[EaseMob sharedInstance].chatManager loginInfo][kSDKUsername]])
    {
        latestMessageTitle = NSLocalizedString(@"message.burn", @"[Burn after reading]");
        return latestMessageTitle;
    }
    id<IEMMessageBody> messageBody = latestMessage.messageBodies.lastObject;
    
    //  TODO:Step7. 开始位置
    if (messageBody.messageBodyType == eMessageBodyType_Text) {
        NSDictionary *dict = latestMessage.ext;
        
      if ([dict valueForKey:RedpacketKeyRedpacketTakenMessageSign]) {
            /**
             *  红包被抢的消息
             */
            NSString *senderID = [dict valueForKey:RedpacketKeyRedpacketSenderId];
            NSString *currentUserID = [[[[EaseMob sharedInstance] chatManager] loginInfo] objectForKey:kSDKUsername];
            if ([senderID isEqualToString:currentUserID]) {
                /**
                 *  发送红包的用户就是当前用户
                 */
                NSString *receiver = [dict valueForKey:RedpacketKeyRedpacketReceiverNickname];
                NSString *receiverID = [dict valueForKey:RedpacketKeyRedpacketReceiverId];
                NSString *prompt;
                
                if ([senderID isEqualToString:receiverID]) {
                    /**
                     *  自己抢了自己的红包
                     */
                    prompt = @"你领取了自己的红包";
                }else {
                    /**
                     *  别人领取了当前用户的红包
                     */
                    prompt = [NSString stringWithFormat:@"%@领取了你的红包", receiver];;
                }
                
                ((EMTextMessageBody *)messageBody).text = prompt;
            }
        }
    }
    
    //  END: Redpacket Modify
    ...
    ...
}```
#### Step8.零钱页

**@Class:** *SettingsViewController*
**@description:**
'ChatDemoUI3.0'的零钱页放在了`SettingsViewController`页面里。 通过`[RedpacketViewControl changeMoneyController]`获取零钱页。


#### Step9.快喊老板来发红包了


#####注意
* 环信红包是基于`ChatDemoUI3.0`开发的，以上介绍也是基于`ChatDemoUI3.0`，如果您的APP不依赖于环信'`ChatDemoUI3.0`'的`ChatViewController`，或者不依赖于`EaseUI`，可以参考`ChatWithRedPacketViewController`自行实现红包功能。
* 红包的零钱页放在了`ChatDemoUI3.0`中的设置页面。
* 宏定义开启关闭红包功能。 只需在pch文件中注释掉此宏定义。

```
	#define REDPACKET_AVALABLE```